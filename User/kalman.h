#ifndef __KALMAN_H
#define __KALMAN_H
/*
 *!
 * \file       : kalman.h
 * \brief      : 
 * \version    : 
 * \date       : 2021/04/02
 * \author     : Yueyang Jiang
 * Last modified by Yueyang Jiang 2021/04/02
 * Copyright (c) 2021 by Yueyang Jiang. All Rights Reserved.
 */
   
/*Includes ----------------------------------------------*/
#include <stdio.h>
#include "arm_math.h"
#include "fatfs_sd.h"
#include "ADC.h"

/* \defgroup KALMAN_Exported_TypesDefinitions
 * \{
 */
typedef struct{
	float P[4];/*predicted covariance matrix*/
	float C[2];/*observation matrix*/
	float kg[2];/*kalman gain*/
	float Xest[2];/*state estimate*/
	float Ex;/*covariance matrix of process noise*/
	float Ez;/*covariance matrix of mesure noise*/
	float Inno;/*innovation*/
	uint16_t Round;
}KalmanMat;

/**
 * \}
 */
   
/* \defgroup KALMAN_Exported_Defines
 * \{
 */
/*kalman filter*/
#define Q           				1e-3    //covariance of process noise
#define ONE_PERIOD_SAMPLES	250
#define HALF_DIFF_SIZE 			HALF_BUFFER_SIZE-3
/**
 * \}
 */
   
/* \defgroup KALMAN_Exported_Macros
 * \{
 */

/**
 * \}
 */
   
/* \defgroup KALMAN_Exported_Variables
 * \{
 */
/*matrix inital*/
static float32_t Ex_data[4] = {Q, 0.0, 0.0, Q};
static float32_t X_est_init_data[2] = {0.8, 0.1};
/*variable kalman*/
static KalmanMat km;
/*Input buffer*/
extern float Current_Buffer[ADC_BUFFER_SIZE];
/*Output buffer*/
static float32_t diff1_Buffer[ADC_BUFFER_SIZE];
static float32_t diff2_Buffer[ADC_BUFFER_SIZE];

extern float32_t X2_Buffer[ADC_BUFFER_SIZE];
extern float32_t X1_Buffer[ADC_BUFFER_SIZE];
extern float32_t diff3_Buffer[ADC_BUFFER_SIZE];
extern float32_t Res_Buffer[ADC_BUFFER_SIZE];

/**
 * \}
 */
   
/* \defgroup KALMAN_Exported_Functions
 * \{
 */
static void Difference3rd(float* pSrc, uint16_t size);
static void Kalman_Update(float Y, float* pX2, float* Res);
void Kalman_Inite(void);
void Kalman_Filter(uint16_t size);

static float C1_data[2000] = {1	,
0.994951017	,
0.979855052	,
0.954864545	,
0.920231847	,
0.87630668	,
0.823532598	,
0.762442511	,
0.693653306	,
0.617859613	,
0.535826795	,
0.448383216	,
0.356411879	,
0.260841506	,
0.162637165	,
0.06279052	,
-0.037690183	,
-0.137790291	,
-0.236498997	,
-0.332819545	,
-0.425779292	,
-0.514439534	,
-0.597904983	,
-0.675332808	,
-0.745941145	,
-0.809016994	,
-0.863923417	,
-0.910105971	,
-0.947098305	,
-0.974526873	,
-0.992114701	,
-0.999684189	,
-0.9971589	,
-0.984564335	,
-0.962027672	,
-0.929776486	,
-0.888136449	,
-0.83752804	,
-0.778462302	,
-0.711535677	,
-0.63742399	,
-0.556875616	,
-0.470703932	,
-0.379779096	,
-0.285019262	,
-0.187381315	,
-0.087851197	,
0.01256604	,
0.112856385	,
0.21200711	,
0.309016994	,
0.402906436	,
0.492727342	,
0.577572703	,
0.656585756	,
0.728968627	,
0.793990399	,
0.850994482	,
0.899405252	,
0.938733858	,
0.968583161	,
0.988651745	,
0.998736957	,
0.998736957	,
0.988651745	,
0.968583161	,
0.938733858	,
0.899405252	,
0.850994482	,
0.793990399	,
0.728968627	,
0.656585756	,
0.577572703	,
0.492727342	,
0.402906436	,
0.309016994	,
0.21200711	,
0.112856385	,
0.01256604	,
-0.087851197	,
-0.187381315	,
-0.285019262	,
-0.379779096	,
-0.470703932	,
-0.556875616	,
-0.63742399	,
-0.711535677	,
-0.778462302	,
-0.83752804	,
-0.888136449	,
-0.929776486	,
-0.962027672	,
-0.984564335	,
-0.9971589	,
-0.999684189	,
-0.992114701	,
-0.974526873	,
-0.947098305	,
-0.910105971	,
-0.863923417	,
-0.809016994	,
-0.745941145	,
-0.675332808	,
-0.597904983	,
-0.514439534	,
-0.425779292	,
-0.332819545	,
-0.236498997	,
-0.137790291	,
-0.037690183	,
0.06279052	,
0.162637165	,
0.260841506	,
0.356411879	,
0.448383216	,
0.535826795	,
0.617859613	,
0.693653306	,
0.762442511	,
0.823532598	,
0.87630668	,
0.920231847	,
0.954864545	,
0.979855052	,
0.994951017	,
1	,
0.994951017	,
0.979855052	,
0.954864545	,
0.920231847	,
0.87630668	,
0.823532598	,
0.762442511	,
0.693653306	,
0.617859613	,
0.535826795	,
0.448383216	,
0.356411879	,
0.260841506	,
0.162637165	,
0.06279052	,
-0.037690183	,
-0.137790291	,
-0.236498997	,
-0.332819545	,
-0.425779292	,
-0.514439534	,
-0.597904983	,
-0.675332808	,
-0.745941145	,
-0.809016994	,
-0.863923417	,
-0.910105971	,
-0.947098305	,
-0.974526873	,
-0.992114701	,
-0.999684189	,
-0.9971589	,
-0.984564335	,
-0.962027672	,
-0.929776486	,
-0.888136449	,
-0.83752804	,
-0.778462302	,
-0.711535677	,
-0.63742399	,
-0.556875616	,
-0.470703932	,
-0.379779096	,
-0.285019262	,
-0.187381315	,
-0.087851197	,
0.01256604	,
0.112856385	,
0.21200711	,
0.309016994	,
0.402906436	,
0.492727342	,
0.577572703	,
0.656585756	,
0.728968627	,
0.793990399	,
0.850994482	,
0.899405252	,
0.938733858	,
0.968583161	,
0.988651745	,
0.998736957	,
0.998736957	,
0.988651745	,
0.968583161	,
0.938733858	,
0.899405252	,
0.850994482	,
0.793990399	,
0.728968627	,
0.656585756	,
0.577572703	,
0.492727342	,
0.402906436	,
0.309016994	,
0.21200711	,
0.112856385	,
0.01256604	,
-0.087851197	,
-0.187381315	,
-0.285019262	,
-0.379779096	,
-0.470703932	,
-0.556875616	,
-0.63742399	,
-0.711535677	,
-0.778462302	,
-0.83752804	,
-0.888136449	,
-0.929776486	,
-0.962027672	,
-0.984564335	,
-0.9971589	,
-0.999684189	,
-0.992114701	,
-0.974526873	,
-0.947098305	,
-0.910105971	,
-0.863923417	,
-0.809016994	,
-0.745941145	,
-0.675332808	,
-0.597904983	,
-0.514439534	,
-0.425779292	,
-0.332819545	,
-0.236498997	,
-0.137790291	,
-0.037690183	,
0.06279052	,
0.162637165	,
0.260841506	,
0.356411879	,
0.448383216	,
0.535826795	,
0.617859613	,
0.693653306	,
0.762442511	,
0.823532598	,
0.87630668	,
0.920231847	,
0.954864545	,
0.979855052	,
0.994951017	
};

static float C2_data[2000] = {0	,
0.100361715	,
0.199709981	,
0.297041582	,
0.391373667	,
0.481753674	,
0.567268949	,
0.647055962	,
0.720309025	,
0.786288432	,
0.844327926	,
0.893841424	,
0.934328942	,
0.965381639	,
0.986685944	,
0.998026728	,
0.999289473	,
0.990461426	,
0.971631733	,
0.942990536	,
0.904827052	,
0.857526656	,
0.801566985	,
0.737513117	,
0.666011867	,
0.587785252	,
0.503623202	,
0.414375581	,
0.32094361	,
0.224270761	,
0.125333234	,
0.025130095	,
-0.075326806	,
-0.175023059	,
-0.272951936	,
-0.368124553	,
-0.459579861	,
-0.546394347	,
-0.627691361	,
-0.70264997	,
-0.770513243	,
-0.830595899	,
-0.882291226	,
-0.925077207	,
-0.958521789	,
-0.982287251	,
-0.996133609	,
-0.999921044	,
-0.993611311	,
-0.977268124	,
-0.951056516	,
-0.915241173	,
-0.870183755	,
-0.816339251	,
-0.754251381	,
-0.684547106	,
-0.607930298	,
-0.52517463	,
-0.437115767	,
-0.344642923	,
-0.248689887	,
-0.150225589	,
-0.050244318	,
0.050244318	,
0.150225589	,
0.248689887	,
0.344642923	,
0.437115767	,
0.52517463	,
0.607930298	,
0.684547106	,
0.754251381	,
0.816339251	,
0.870183755	,
0.915241173	,
0.951056516	,
0.977268124	,
0.993611311	,
0.999921044	,
0.996133609	,
0.982287251	,
0.958521789	,
0.925077207	,
0.882291226	,
0.830595899	,
0.770513243	,
0.70264997	,
0.627691361	,
0.546394347	,
0.459579861	,
0.368124553	,
0.272951936	,
0.175023059	,
0.075326806	,
-0.025130095	,
-0.125333234	,
-0.224270761	,
-0.32094361	,
-0.414375581	,
-0.503623202	,
-0.587785252	,
-0.666011867	,
-0.737513117	,
-0.801566985	,
-0.857526656	,
-0.904827052	,
-0.942990536	,
-0.971631733	,
-0.990461426	,
-0.999289473	,
-0.998026728	,
-0.986685944	,
-0.965381639	,
-0.934328942	,
-0.893841424	,
-0.844327926	,
-0.786288432	,
-0.720309025	,
-0.647055962	,
-0.567268949	,
-0.481753674	,
-0.391373667	,
-0.297041582	,
-0.199709981	,
-0.100361715	,
-4.90E-16	,
0.100361715	,
0.199709981	,
0.297041582	,
0.391373667	,
0.481753674	,
0.567268949	,
0.647055962	,
0.720309025	,
0.786288432	,
0.844327926	,
0.893841424	,
0.934328942	,
0.965381639	,
0.986685944	,
0.998026728	,
0.999289473	,
0.990461426	,
0.971631733	,
0.942990536	,
0.904827052	,
0.857526656	,
0.801566985	,
0.737513117	,
0.666011867	,
0.587785252	,
0.503623202	,
0.414375581	,
0.32094361	,
0.224270761	,
0.125333234	,
0.025130095	,
-0.075326806	,
-0.175023059	,
-0.272951936	,
-0.368124553	,
-0.459579861	,
-0.546394347	,
-0.627691361	,
-0.70264997	,
-0.770513243	,
-0.830595899	,
-0.882291226	,
-0.925077207	,
-0.958521789	,
-0.982287251	,
-0.996133609	,
-0.999921044	,
-0.993611311	,
-0.977268124	,
-0.951056516	,
-0.915241173	,
-0.870183755	,
-0.816339251	,
-0.754251381	,
-0.684547106	,
-0.607930298	,
-0.52517463	,
-0.437115767	,
-0.344642923	,
-0.248689887	,
-0.150225589	,
-0.050244318	,
0.050244318	,
0.150225589	,
0.248689887	,
0.344642923	,
0.437115767	,
0.52517463	,
0.607930298	,
0.684547106	,
0.754251381	,
0.816339251	,
0.870183755	,
0.915241173	,
0.951056516	,
0.977268124	,
0.993611311	,
0.999921044	,
0.996133609	,
0.982287251	,
0.958521789	,
0.925077207	,
0.882291226	,
0.830595899	,
0.770513243	,
0.70264997	,
0.627691361	,
0.546394347	,
0.459579861	,
0.368124553	,
0.272951936	,
0.175023059	,
0.075326806	,
-0.025130095	,
-0.125333234	,
-0.224270761	,
-0.32094361	,
-0.414375581	,
-0.503623202	,
-0.587785252	,
-0.666011867	,
-0.737513117	,
-0.801566985	,
-0.857526656	,
-0.904827052	,
-0.942990536	,
-0.971631733	,
-0.990461426	,
-0.999289473	,
-0.998026728	,
-0.986685944	,
-0.965381639	,
-0.934328942	,
-0.893841424	,
-0.844327926	,
-0.786288432	,
-0.720309025	,
-0.647055962	,
-0.567268949	,
-0.481753674	,
-0.391373667	,
-0.297041582	,
-0.199709981	,
-0.100361715	
};
/**
 * \}
 */
#endif  
/************************ (C) COPYRIGHT Yueyang Jiang *****END OF FILE****/

